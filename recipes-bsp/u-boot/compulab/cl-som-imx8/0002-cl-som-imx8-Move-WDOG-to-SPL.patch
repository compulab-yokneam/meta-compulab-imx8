From 45475b94f4ac47c6ac656fd07cd2042c5d8ce880 Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Tue, 2 Jan 2018 15:25:44 +0200
Subject: [PATCH 02/11] cl-som-imx8: Move WDOG to SPL

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 board/compulab/cl-som-imx8/cl-som-imx8.c |  5 -----
 board/compulab/cl-som-imx8/common.c      | 14 ++++++++++++++
 include/configs/cl-som-imx8.h            |  1 +
 3 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/board/compulab/cl-som-imx8/cl-som-imx8.c b/board/compulab/cl-som-imx8/cl-som-imx8.c
index d45d8b5..19a370a 100644
--- a/board/compulab/cl-som-imx8/cl-som-imx8.c
+++ b/board/compulab/cl-som-imx8/cl-som-imx8.c
@@ -188,11 +188,6 @@ int board_mmc_get_env_dev(int devno)
 
 int board_late_init(void)
 {
-	struct wdog_regs *wdog = (struct wdog_regs *)WDOG1_BASE_ADDR;
-
-	imx_iomux_v3_setup_multiple_pads(wdog_pads, ARRAY_SIZE(wdog_pads));
-
-	set_wdog_reset(wdog);
 
 #ifdef CONFIG_ENV_IS_IN_MMC
 	board_late_mmc_env_init();
diff --git a/board/compulab/cl-som-imx8/common.c b/board/compulab/cl-som-imx8/common.c
index dc35fe4..08280bd 100644
--- a/board/compulab/cl-som-imx8/common.c
+++ b/board/compulab/cl-som-imx8/common.c
@@ -4,6 +4,8 @@
 #include <asm-generic/gpio.h>
 #include <asm/imx-common/gpio.h>
 
+void set_wdog_reset(struct wdog_regs *wdog);
+
 #ifdef CONFIG_MXC_SPI
 
 #define ECSPI_PAD_CTRL	(PAD_CTL_DSE2 | PAD_CTL_HYS)
@@ -33,6 +35,12 @@ int board_spi_cs_gpio(unsigned bus, unsigned cs)
 }
 #endif
 
+#define WDOG_PAD_CTRL	(PAD_CTL_DSE6 | PAD_CTL_HYS | PAD_CTL_PUE)
+
+static iomux_v3_cfg_t const wdog_pads[] = {
+	IMX8MQ_PAD_GPIO1_IO02__WDOG1_WDOG_B | MUX_PAD_CTRL(WDOG_PAD_CTRL),
+};
+
 #define UART_PAD_CTRL	(PAD_CTL_DSE6 | PAD_CTL_FSEL1)
 
 static iomux_v3_cfg_t const uart_pads[] = {
@@ -42,6 +50,12 @@ static iomux_v3_cfg_t const uart_pads[] = {
 
 int board_early_init_f(void)
 {
+	struct wdog_regs *wdog = (struct wdog_regs *)WDOG1_BASE_ADDR;
+
+	imx_iomux_v3_setup_multiple_pads(wdog_pads, ARRAY_SIZE(wdog_pads));
+
+	set_wdog_reset(wdog);
+
 	imx_iomux_v3_setup_multiple_pads(uart_pads, ARRAY_SIZE(uart_pads));
 
 	return 0;
diff --git a/include/configs/cl-som-imx8.h b/include/configs/cl-som-imx8.h
index a87225b..a11a88a 100644
--- a/include/configs/cl-som-imx8.h
+++ b/include/configs/cl-som-imx8.h
@@ -20,6 +20,7 @@
 
 #ifdef CONFIG_SPL_BUILD
 /*#define CONFIG_ENABLE_DDR_TRAINING_DEBUG*/
+#define CONFIG_SPL_WATCHDOG_SUPPORT
 #define CONFIG_SPL_POWER_SUPPORT
 #define CONFIG_SPL_I2C_SUPPORT
 #define CONFIG_SPL_BOARD_INIT
-- 
1.9.1

